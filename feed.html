<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Feed</title>
    <style>
      @import url("https://fonts.googleapis.com/css?family=Montserrat");
      @import url("https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css");
      @import url("https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css");

      /* ===== Scrollbar CSS ===== */
      /* Firefox */
      * {
        scrollbar-width: auto;
        scrollbar-color: #18181b #18181b;
      }

      /* Chrome, Edge, and Safari */
      *::-webkit-scrollbar {
        width: 10px;
      }

      *::-webkit-scrollbar-track {
        background: #18181b;
      }

      *::-webkit-scrollbar-thumb {
        background-color: #18181b;
        border-radius: 5px;
        border: 1px solid #6c757d;
      }

      body {
        font-family: "Montserrat", sans-serif;
        background-color: #18181b;
        overflow-x: hidden;
        overflow-y: scroll;
      }

      .show {
        opacity: 1 !important;
      }

      .hide {
        opacity: 0 !important;
      }

      .emote {
        max-width: 2rem;
      }
    </style>
  </head>

  <body class="text-light">
    <div class="container-fluid">
      <div class="events my-3"></div>
    </div>
    <script type="module">
      import Toast from "https://esm.run/bootstrap/js/dist/toast";
      import format from "https://esm.run/date-fns/format";

      try {
        (function connectWs() {
          if ("WebSocket" in window) {
            function attachEmotes(message, emotes) {
              if (!message.length) return;
              message = html_encode(message);
              emotes = emotes.map((emote) => {
                return {
                  text: html_encode(
                    message.substring(emote.startIndex, emote.endIndex + 1)
                  ),
                  image: emote.imageUrl,
                };
              });
              return message.replace(/([^\s]*)/gi, function (text) {
                if (!text.length) return text;
                let result = emotes.find(
                  (emote) => emote.text === html_encode(text)
                );
                if (result && result.image)
                  return `<img class="emote" src="${result.image.replace(
                    /animated\/(.*)\.gif/i,
                    "static/$1.png"
                  )}"/>`;
                return text;
              });
            }

            function html_encode(e) {
              if (typeof e === "string") {
                return e.replace(/[<>"^]/g, function (e) {
                  return `&#${e.charCodeAt(0)};`;
                });
              }
            }

            function animateCSS(element, animation, prefix = "animate__") {
              return new Promise((resolve, reject) => {
                const animationName = `${prefix}${animation}`;
                const node =
                  typeof element === "object" &&
                  (element instanceof Node || element instanceof HTMLElement)
                    ? element
                    : document.querySelector(element);
                node.classList.add(`${prefix}animated`, animationName);
                function handleAnimationEnd(event) {
                  event.stopPropagation();
                  node.classList.remove(`${prefix}animated`, animationName);
                  resolve("Animation ended");
                }
                node.addEventListener("animationend", handleAnimationEnd, {
                  once: true,
                });
              });
            }

            function createToast(args, autohide = false) {
              const { title, body } = Object.assign(
                {
                  title: "",
                  body: "",
                },
                args,
                {}
              );
              const toast = document.createElement("div");
              toast.classList.add(
                "toast",
                "w-100",
                "bg-dark",
                "text-light",
                "mb-3"
              );
              toast.ariaAtomic = true;
              toast.ariaLive = "assertive";
              toast.setAttribute("role", "chat");
              toast.innerHTML = `
      <div class="toast-header bg-secondary text-light">
        <span class="me-auto">${title}</span>
        <small>${format(new Date(), "HH:mm")}</small>
      </div>
      <div class="toast-body">${body}</div>
      `;
              document.querySelector(".events").prepend(toast);
              animateCSS(toast, "fadeInRight");
              new Toast(toast, {
                animation: false,
                autohide,
              }).show();
            }

            const ws = new WebSocket("ws://localhost:8080/");

            ws.onopen = function () {
              ws.send(
                JSON.stringify({
                  request: "Subscribe",
                  events: {
                    twitch: [
                      "Follow",
                      "Cheer",
                      "Sub",
                      "ReSub",
                      "GiftSub",
                      "GiftBomb",
                      "Raid",
                      "HypeTrainStart",
                      "HypeTrainUpdate",
                      "HypeTrainLevelUp",
                      "HypeTrainEnd",
                      "RewardRedemption",
                      "CommunityGoalContribution",
                      "CommunityGoalEnded",
                      "StreamUpdate",
                      "Whisper",
                      "FirstWord",
                      "SubCounterRollover",
                      "BroadcastUpdate",
                      "StreamUpdateGameOnConnect",
                      "Host",
                    ],
                    streamElements: ["Tip"],
                  },
                  id: "feed",
                })
              );
            };

            ws.onmessage = function (event) {
              event = JSON.parse(event?.data);
              if (!event) return;
              console.log(event);

              if (event?.id === "feed" && event?.status === "ok")
                return createToast({
                  title: "üî¥ Conectado",
                  body: "Feed conectado com sucesso!",
                });

              if (event?.event?.source === "StreamElements") {
                if (event?.event?.type === "Tip")
                  return createToast({
                    title: `ü™ô ${Number(event?.data?.amount).toLocaleString(
                      "pt-BR",
                      {
                        style: "currency",
                        currency: event?.data?.currency,
                      }
                    )} ‚ÜîÔ∏è ${event?.data?.username}`,
                    body: event?.data?.message,
                  });
              }

              if (event?.event?.source === "Twitch") {
                switch (event?.event?.type) {
                  case "Sub":
                    return createToast({
                      title: "‚≠ê Sub",
                      body: `<div class="fs-5">${event?.data?.displayName}</div>`,
                    });

                  case "ReSub":
                    const message = attachEmotes(
                      event?.data?.message || "",
                      event?.data?.emotes || []
                    );
                    return createToast({
                      title: `‚≠ê ReSub (${event?.data?.cumulativeMonths}x)`,
                      body: `<div class="fs-5">${event?.data?.displayName}</div>
                      ${
                        message
                          ? `<div class="alert alert-success m-0 p-2">${message}</div>`
                          : ""
                      }`,
                    });

                  case "GiftSub":
                    return createToast({
                      title: `‚≠ê Gift Sub`,
                      body: `<div class="fs-6">${
                        event?.data?.recipientDisplayName
                      } ganhou uma ${
                        event?.data?.cumulativeMonths > 1
                          ? "reinscri√ß√£o"
                          : "inscri√ß√£o"
                      } de ${event?.data?.displayName}!</div>`,
                    });

                  case "GiftBomb":
                    return createToast({
                      title: `‚≠ê Gift Bomb`,
                      body: `${event?.data?.displayName} enviou ${event?.data?.gifts} gift subs!`,
                    });

                  case "Follow":
                    return createToast({
                      title: "üíú Follow",
                      body: `<span class="fs-5">${event?.data?.displayName}</span>`,
                    });

                  case "Cheer":
                    return createToast({
                      title: `üíé ${event?.data.message?.bits} bits ‚ÜîÔ∏è ${event?.data?.message?.displayName}`,
                      body: attachEmotes(
                        event?.data?.message?.message || "",
                        event?.data?.message?.cheerEmotes || []
                      ),
                    });

                  case "Raid":
                  case "Host":
                    return createToast({
                      title: `üëã ${event?.event?.type} (${
                        event?.data?.viewerCount || 0
                      } viewers)`,
                      body: `<span class="fs-5">${event?.data?.displayName}</span>`,
                    });

                  case "HypeTrainStart":
                    return createToast({
                      title: `üöÇ Hype train!`,
                      body: "Olha o trem chegando!",
                    });

                  case "HypeTrainLevelUp":
                    return createToast({
                      title: `üöÇ Hype train!`,
                      body: `Hype train level ${event?.data?.level}!`,
                    });

                  case "HypeTrainEnd":
                    return createToast({
                      title: `üöÇ Hype train!`,
                      body: `Hype train passou!`,
                    });

                  case "Whisper":
                    return createToast(
                      {
                        title: `ü§´ Sussurro ‚ÜîÔ∏è ${event?.data?.message?.displayName}`,
                        body: event?.data?.message?.message,
                      },
                      true
                    );

                  default:
                    break;
                }
              }
            };

            ws.onclose = function () {
              setTimeout(connectWs, 10000);
            };
          }
        })();
      } catch (err) {
        console.log(err);
      }
    </script>
  </body>
</html>
